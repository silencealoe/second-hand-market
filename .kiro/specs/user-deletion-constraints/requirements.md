# 用户删除外键约束处理需求

## 项目概述
解决用户删除时的外键约束问题，当用户存在关联数据（商品、订单、评论、购物车）时，提供智能的删除策略和用户友好的交互体验。

## 问题描述
当前系统在删除商城用户时遇到外键约束错误：
```
Cannot delete or update a parent row: a foreign key constraint fails 
(`second_hand_market`.`products`, CONSTRAINT `FK_176b502c5ebd6e72cafbd9d6f70` 
FOREIGN KEY (`user_id`) REFERENCES `users` (`id`))
```

这是因为用户表与其他表存在外键关系，直接删除用户会违反数据库完整性约束。

## 用户故事

### 1. 智能删除检查
**作为** 系统管理员  
**我希望** 在删除用户前能够了解该用户的关联数据情况  
**以便** 我可以做出明智的删除决策

**验收标准：**
- [ ] 删除用户前自动检查关联数据
- [ ] 显示关联数据的详细统计信息
- [ ] 根据关联数据情况提供不同的删除选项
- [ ] 提供清晰的操作指导和风险提示

### 2. 安全删除机制
**作为** 系统管理员  
**我希望** 系统能够安全地处理用户删除操作  
**以便** 避免数据完整性问题和意外的数据丢失

**验收标准：**
- [ ] 没有关联数据的用户可以直接删除
- [ ] 有关联数据的用户需要确认后才能删除
- [ ] 提供强制删除选项（包括关联数据）
- [ ] 所有删除操作使用数据库事务确保一致性

### 3. 用户友好的交互体验
**作为** 系统管理员  
**我希望** 删除操作有清晰的界面提示和确认流程  
**以便** 我能够准确理解操作后果并做出正确选择

**验收标准：**
- [ ] 显示关联数据的具体数量和类型
- [ ] 提供不同删除选项的清晰说明
- [ ] 重要操作有明显的警告提示
- [ ] 操作结果有及时的反馈信息

### 4. 数据完整性保护
**作为** 系统架构师  
**我希望** 删除操作不会破坏数据完整性  
**以便** 系统能够保持稳定和可靠

**验收标准：**
- [ ] 使用数据库事务确保操作原子性
- [ ] 删除失败时能够正确回滚
- [ ] 保留重要的业务数据（如订单历史）
- [ ] 提供数据备份和恢复机制

## 技术要求

### 后端要求
- 使用 NestJS + TypeORM
- 实现事务性删除操作
- 提供关联数据检查API
- 支持选择性删除关联数据
- 完善的错误处理和日志记录

### 前端要求
- 使用 React + Ant Design
- 智能的删除确认对话框
- 关联数据可视化展示
- 操作进度和结果反馈
- 响应式设计支持

### 数据库要求
- 保持现有外键约束
- 支持级联删除选项
- 事务性操作支持
- 数据完整性验证

## 业务规则

### 删除策略
1. **直接删除**：用户无任何关联数据时可直接删除
2. **确认删除**：用户有关联数据时需要管理员确认
3. **强制删除**：删除用户及其所有关联数据
4. **保护删除**：保留重要数据，只删除用户账户

### 关联数据处理
- **商品数据**：可选择删除或转移给其他用户
- **订单数据**：建议保留用于历史记录和财务审计
- **评论数据**：可选择删除或匿名化处理
- **购物车数据**：可以安全删除

### 权限控制
- 只有超级管理员可以执行强制删除
- 普通管理员只能删除无关联数据的用户
- 所有删除操作需要记录操作日志

## 安全要求

### 数据保护
- 重要业务数据（订单、支付记录）不应轻易删除
- 提供数据匿名化选项而非物理删除
- 实现软删除机制保留数据可追溯性

### 操作审计
- 记录所有删除操作的详细日志
- 包含操作人、操作时间、删除范围等信息
- 支持操作历史查询和审计

### 权限验证
- 验证操作人员的删除权限
- 重要操作需要二次确认
- 支持操作撤销机制（在可能的情况下）

## 性能要求
- 关联数据检查响应时间 < 1秒
- 删除操作响应时间 < 5秒
- 支持批量删除操作
- 大量关联数据的处理优化

## 用户体验要求
- 操作流程简单直观
- 提供清晰的操作指导
- 重要操作有明显的视觉提示
- 支持操作撤销和恢复

## 测试要求
- 单元测试覆盖率 > 90%
- 集成测试覆盖所有删除场景
- 压力测试验证大数据量处理
- 安全测试验证权限控制

## 验收测试场景

### 场景1：无关联数据用户删除
1. 选择一个没有任何关联数据的用户
2. 点击删除按钮
3. 验证用户被直接删除
4. 验证操作日志记录正确

### 场景2：有关联数据用户删除
1. 选择一个有关联数据的用户
2. 点击删除按钮
3. 验证显示关联数据统计信息
4. 选择强制删除选项
5. 验证用户及关联数据被删除
6. 验证操作日志记录正确

### 场景3：删除操作失败处理
1. 模拟数据库连接失败
2. 尝试删除用户
3. 验证操作失败并回滚
4. 验证错误信息正确显示
5. 验证数据完整性未受影响

### 场景4：权限控制测试
1. 使用普通管理员账号
2. 尝试强制删除有关联数据的用户
3. 验证权限检查生效
4. 验证操作被拒绝并显示相应提示

## 成功指标
- 用户删除成功率 > 99%
- 删除操作响应时间 < 5秒
- 零数据完整性问题
- 用户满意度提升
- 客服咨询减少 50%

## 风险评估
- **数据丢失风险**：通过事务和备份机制降低
- **性能影响风险**：通过优化查询和异步处理降低
- **用户体验风险**：通过充分测试和用户反馈降低
- **安全风险**：通过权限控制和审计日志降低